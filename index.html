<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Wedding Checklist ‚Äî Mobile</title>

  <!-- Use system font for iPhone-like feel -->
  <meta name="color-scheme" content="light dark">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Minimal Bootstrap for modal & basic utilities -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* ---------- Base (mobile-first) ---------- */
    :root{
      --bg: #fbf9ff;
      --glass: rgba(255,255,255,0.6);
      --accent: #6b5cff;       /* soft purple */
      --accent-2: #5cc8ff;     /* soft cyan */
      --muted: #8b8b9a;
      --card-radius: 16px;
      --glass-blur: 12px;
      --shadow-1: 0 6px 20px rgba(34,34,60,0.10);
      --glass-border: rgba(255,255,255,0.35);
      --glass-ghost: rgba(255,255,255,0.08);
      --success: #16a34a;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background: linear-gradient(180deg, #fffefe 0%, #fff7fb 100%);
      color: #111827;
      -webkit-tap-highlight-color: transparent;
    }

    /* Container */
    .app {
      max-width: 720px;
      margin: 0 auto;
      padding: 18px;
    }

    /* Header card (glass) */
    .hdr {
      background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(250,248,255,0.6));
      border-radius: var(--card-radius);
      padding: 14px;
      box-shadow: var(--shadow-1);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(var(--glass-blur));
      display:flex;
      gap:12px;
      align-items:center;
    }
    .hdr .title {
      font-weight:700;
      font-size:1.05rem;
      letter-spacing: -0.2px;
    }
    .hdr .sub {
      font-size: .78rem;
      color: var(--muted);
    }

    /* wedding date + countdown compact */
    .countdownWrap {
      margin-left:auto;
      text-align:right;
      min-width: 120px;
    }
    .countdown {
      font-weight:700;
      font-size: .95rem;
      color: #0f172a;
    }
    .wdate {
      font-size:.78rem;
      color: var(--muted);
      margin-top:2px;
    }

    /* Timeline (glass stripe) */
    .timelineWrap {
      margin-top:14px;
      border-radius: 12px;
      padding: 10px;
      background: linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));
      border: 1px solid rgba(0,0,0,0.04);
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 24px rgba(12,12,30,0.06);
    }
    .timelineRow {
      display:flex;
      gap:8px;
      align-items:center;
      overflow:hidden;
      padding:8px 6px;
    }
    .segment {
      flex:1;
      min-width: 0;
      height:46px;
      border-radius: 10px;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.78rem;
      font-weight:600;
      color: #0f172a;
      box-shadow: inset 0 -4px 14px rgba(0,0,0,0.03);
    }
    /* Soft tonal colors: on=blue, almost=yellow, late=red, complete=green */
    .seg-blue{ background: linear-gradient(180deg, rgba(92,154,255,0.12), rgba(218,236,255,0.06)); border:1px solid rgba(92,154,255,0.06); }
    .seg-yellow{ background: linear-gradient(180deg, rgba(255,223,138,0.12), rgba(255,249,230,0.04)); border:1px solid rgba(255,223,138,0.06); }
    .seg-red{ background: linear-gradient(180deg, rgba(255,164,164,0.12), rgba(255,242,242,0.04)); border:1px solid rgba(255,164,164,0.06); }
    .seg-green{ background: linear-gradient(180deg, rgba(167,255,199,0.12), rgba(240,255,244,0.04)); border:1px solid rgba(167,255,199,0.06); }

    /* task pin (floating droplet) */
    .pin {
      position:absolute;
      width:12px; height:18px;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      transform: translateX(-50%) translateY(-60%);
      box-shadow: 0 6px 18px rgba(10,12,20,0.12);
      border:2px solid rgba(255,255,255,0.9);
      transition: transform .18s ease, opacity .18s ease;
    }
    .pin:hover { transform: translateX(-50%) translateY(-75%) scale(1.08); }

    /* Controls row */
    .controls {
      margin-top:12px;
      display:flex; gap:8px; align-items:center;
    }
    .control-chip {
      background: rgba(255,255,255,0.7);
      padding:6px 10px;
      border-radius: 999px;
      font-weight:600;
      font-size:.85rem;
      border:1px solid rgba(0,0,0,0.03);
      box-shadow: 0 6px 18px rgba(12,12,30,0.04);
    }

    /* Task list: cards with glass and drop button */
    .taskList {
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:14px;
    }
    .taskCard {
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.7));
      border-radius: 14px;
      padding:12px;
      box-shadow: 0 10px 30px rgba(9,10,25,0.06);
      border:1px solid rgba(0,0,0,0.04);
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .taskIcon {
      width:44px; height:44px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,255,0.75));
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 6px 18px rgba(12,12,30,0.06);
      flex-shrink:0;
    }
    .taskBody { flex:1; min-width:0; }
    .taskTitle { font-weight:700; font-size: .98rem; margin-bottom:4px; }
    .taskMeta { font-size:.78rem; color:var(--muted); }

    .taskActions { display:flex; gap:8px; margin-left:8px; align-items:center; }

    /* Buttons style (glass droplet) */
    .btn-glass {
      border-radius: 999px;
      padding:8px 12px;
      font-weight:600;
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.6));
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: 0 10px 24px rgba(12,12,30,0.06);
      color: #111827;
      transition: transform .14s linear, box-shadow .14s linear;
    }
    .btn-glass:active { transform: translateY(1px) scale(.997); }
    .btn-accent {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: white;
      border: none;
      box-shadow: 0 10px 30px rgba(107,92,255,0.18);
    }

    /* Completed look */
    .completedTitle { text-decoration: line-through; color: rgba(8,8,8,0.4); }

    /* Floating action button (FAB) */
    .fab {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 1200;
      width:64px;height:64px;border-radius:24px;
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(180deg, var(--accent), var(--accent-2));
      color:#fff;box-shadow: 0 20px 50px rgba(107,92,255,0.22);
      border:none;
      transition: transform .12s ease;
      backdrop-filter: blur(6px);
    }
    .fab:active { transform: scale(.98); }

    /* small screens adjustments */
    @media (max-width:480px){
      .hdr { padding:12px; gap:10px; border-radius:14px; }
      .taskCard { padding:10px; border-radius:12px; }
      .pin { width:10px;height:15px; }
      .fab { width:56px;height:56px; border-radius:18px; }
    }

    /* utilities */
    .muted { color:var(--muted); font-size:.82rem; }
    .tiny { font-size:.72rem; color:var(--muted); }
    .label-pill { font-size:.76rem; padding:6px 8px; border-radius:999px; background: rgba(0,0,0,0.03); }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="hdr">
      <div style="display:flex;gap:10px;align-items:center;">
        <!-- small heart logo -->
        <svg width="42" height="42" viewBox="0 0 24 24" fill="none" aria-hidden>
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="#6b5cff"/>
              <stop offset="1" stop-color="#5cc8ff"/>
            </linearGradient>
          </defs>
          <rect x="0" y="0" width="42" height="42" rx="10" fill="url(#g1)"></rect>
          <path d="M12 20s-6-4.35-8.12-6.5C1.5 10.5 5 6 8.5 6 10.2 6 12 7.5 12 7.5S13.8 6 15.5 6C19 6 22.5 10.5 20.12 13.5 18 15.65 12 20 12 20z" fill="#fff" opacity="0.96"/>
        </svg>
      </div>

      <div>
        <div class="title">Wedding Checklist</div>
        <div class="sub">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ ‚Äî ‡∏û‡∏£‡πâ‡∏≠‡∏° timeline ‡πÅ‡∏•‡∏∞ countdown</div>
      </div>

      <div class="countdownWrap" id="countWrap">
        <div class="countdown" id="countdown">‚Äî</div>
        <div class="wdate tiny">‡∏ß‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏á‡∏≤‡∏ô: <span id="wdateText">‚Äî</span></div>
      </div>
    </div>

    <!-- Timeline -->
    <div class="timelineWrap">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:700">Timeline</div>
        <div class="tiny muted">6m ‚Üí Day</div>
      </div>

      <div class="timelineRow" id="timelineRow">
        <!-- segments inserted dynamically -->
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="control-chip" id="filterChip">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div class="control-chip" id="sortChip">Sort: Oldest</div>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <button class="btn-glass" id="loadSample">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
        <button class="btn-glass" id="resetAll">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </div>

    <!-- Task list -->
    <div class="taskList" id="taskList">
      <!-- cards added here -->
    </div>

    <!-- empty -->
    <div class="muted tiny" id="emptyNote" style="text-align:center;margin-top:18px;display:none;">
      ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
    </div>
  </div>

  <!-- Floating Add Button -->
  <button class="fab" id="fab" aria-label="Add Task">
    <!-- plus icon -->
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
      <path d="M12 5v14M5 12h14" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
  </button>

  <!-- Modal (Bootstrap) for add/edit -->
  <div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" id="taskForm">
        <div class="modal-header" style="border-bottom:none;">
          <h5 class="modal-title" id="modalTitle">New Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="padding-top:0;">
          <input type="hidden" id="taskId">
          <div class="mb-2">
            <label class="form-label small">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
            <input id="taskTitle" class="form-control form-control-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" required>
          </div>
          <div class="mb-2">
            <label class="form-label small">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à</label>
            <input id="taskDue" type="date" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label small">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
            <textarea id="taskDesc" class="form-control" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <div>
              <label class="form-label small mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
              <select id="taskStatus" class="form-select">
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            <div style="margin-left:auto" class="tiny muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ On/Almost/Late ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
          </div>
        </div>
        <div class="modal-footer" style="border-top:none;">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="btn btn-accent">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Date selector bottom sheet (small) -->
  <div style="position:fixed;left:14px;bottom:18px; z-index:1100;">
    <input id="weddingDateInput" type="date" style="border:none; background:transparent; font-weight:600; color:#111827;" title="Set Wedding Date">
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /*****************************************
     * Wedding Checklist Manager ‚Äî Single-file
     * Modern mobile-first UI (glassmorphism)
     * Features:
     * - add/edit/delete tasks (modal)
     * - mark complete/unmark
     * - timeline with colored pins
     * - categories (6m/3m/1m/1w/day)
     * - auto status: on / almost / late / completed
     * - filter & sort
     * - countdown to wedding date
     * - localStorage persistence
     *****************************************/

    /* --------------------- Storage keys --------------------- */
    const KEY_TASKS = 'wcm_tasks_v1';
    const KEY_WEDDING = 'wcm_wedding_v1';

    /* --------------------- helpers --------------------- */
    const $ = sel => document.querySelector(sel);
    const uid = () => 'id_' + Math.random().toString(36).slice(2,9);
    const pad = n => n.toString().padStart(2,'0');

    function iso(d){ return new Date(d).toISOString().slice(0,10); }
    function daysBetween(a,b){ // b - a
      const MS = 1000*60*60*24;
      return Math.floor((Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()) - Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()))/MS);
    }

    /* --------------------- initial sample data (relative to wedding date) --------------------- */
    // default wedding date 6 months from now
    const defaultWedding = (() => {
      const d = new Date();
      d.setMonth(d.getMonth()+6);
      return iso(d);
    })();

    function relativeToWedding(weddingISO, daysBefore){
      const w = new Date(weddingISO + 'T00:00:00');
      w.setDate(w.getDate() + daysBefore); // daysBefore negative -> before wedding
      return iso(w);
    }

    const SAMPLE_TASKS = [
      {id: uid(), title:'‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì', desc:'‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà, ‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏ä‡∏∏‡∏î', dueOffset:-180, status:'pending'},
      {id: uid(), title:'‡∏à‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà', desc:'‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏°‡∏±‡∏î‡∏à‡∏≥', dueOffset:-170, status:'pending'},
      {id: uid(), title:'‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ò‡∏µ‡∏°‡∏á‡∏≤‡∏ô', desc:'‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå', dueOffset:-165, status:'pending'},
      {id: uid(), title:'‡∏à‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û', desc:'‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à', dueOffset:-92, status:'pending'},
      {id: uid(), title:'‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏°‡∏ô‡∏π', desc:'‡∏ä‡∏¥‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å', dueOffset:-85, status:'pending'},
      {id: uid(), title:'‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏ä‡∏¥‡∏ç', desc:'‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏ä‡∏¥‡∏ç', dueOffset:-30, status:'pending'},
      {id: uid(), title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', desc:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô DJ, Catering, Photographer', dueOffset:-28, status:'pending'},
      {id: uid(), title:'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', desc:'‡πÄ‡∏ä‡πá‡∏Å‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á', dueOffset:-6, status:'pending'},
      {id: uid(), title:'‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ', desc:'‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÅ‡∏•‡∏∞‡∏ä‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏≠‡∏á', dueOffset:-5, status:'pending'},
      {id: uid(), title:'‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà', desc:'‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü', dueOffset:0, status:'pending'},
      {id: uid(), title:'‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏Ç‡∏Å', desc:'‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', dueOffset:0, status:'pending'},
      {id: uid(), title:'‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏û‡∏¥‡∏ò‡∏µ', desc:'‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏¥‡∏ò‡∏µ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏û‡∏π‡∏î', dueOffset:-15, status:'pending'},
      {id: uid(), title:'‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏á', desc:'‡∏£‡∏ß‡∏°‡πÄ‡∏û‡∏•‡∏á‡∏û‡∏¥‡∏ò‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô', dueOffset:-40, status:'pending'},
    ];

    /* --------------------- App state --------------------- */
    let tasks = [];
    let weddingDate = localStorage.getItem(KEY_WEDDING) || defaultWedding;
    let filterMode = 'all'; // on / almost / late / completed / all
    let sortMode = 'asc'; // asc = oldest -> newest

    /* --------------------- DOM refs --------------------- */
    const timelineRow = $('#timelineRow');
    const taskList = $('#taskList');
    const emptyNote = $('#emptyNote');
    const countdown = $('#countdown');
    const wdateText = $('#wdateText');
    const weddingDateInput = $('#weddingDateInput');
    const fab = $('#fab');
    const filterChip = $('#filterChip');
    const sortChip = $('#sortChip');

    /* Bootstrap modal */
    const taskModalEl = document.getElementById('taskModal');
    const taskModal = new bootstrap.Modal(taskModalEl);
    const taskForm = $('#taskForm');
    const modalTitle = $('#modalTitle');

    // form fields
    const fId = $('#taskId');
    const fTitle = $('#taskTitle');
    const fDue = $('#taskDue');
    const fDesc = $('#taskDesc');
    const fStatus = $('#taskStatus');

    /* --------------------- Load / Save --------------------- */
    function load(){
      const raw = localStorage.getItem(KEY_TASKS);
      if(raw){
        try { tasks = JSON.parse(raw); }
        catch(e){ tasks = []; }
      } else {
        // seed sample tasks mapped to wedding date
        tasks = SAMPLE_TASKS.map(t => ({
          id: t.id,
          title: t.title,
          desc: t.desc,
          due: relativeToWedding(weddingDate, t.dueOffset),
          status: t.status
        }));
        save();
      }
      weddingDate = localStorage.getItem(KEY_WEDDING) || weddingDate;
    }
    function save(){
      localStorage.setItem(KEY_TASKS, JSON.stringify(tasks));
      localStorage.setItem(KEY_WEDDING, weddingDate);
    }

    /* --------------------- Status calculation --------------------- */
    // returns 'on' / 'almost' / 'late' / 'completed'
    function calcStatus(t){
      if(t.status === 'completed') return 'completed';
      if(!t.due) return 'on';
      const today = new Date();
      const due = new Date(t.due + 'T00:00:00');
      const daysLeft = daysBetween(today, due);
      if(daysLeft < 0) return 'late';
      if(daysLeft <= 3) return 'almost';
      return 'on';
    }

    /* --------------------- Category (time before wedding) --------------------- */
    function categoryLabel(t){
      if(!weddingDate || !t.due) return 'Unscheduled';
      const w = new Date(weddingDate + 'T00:00:00');
      const due = new Date(t.due + 'T00:00:00');
      const daysBefore = daysBetween(due, w); // positive if due before wedding
      if(daysBefore >= 180) return '6 months before';
      if(daysBefore >= 90) return '3 months before';
      if(daysBefore >= 30) return '1 month before';
      if(daysBefore >= 7) return '1 week before';
      if(daysBefore >= 0) return 'day of event';
      return 'After event';
    }

    /* --------------------- Timeline rendering --------------------- */
    function renderTimeline(){
      timelineRow.innerHTML = '';
      // segments: 6m/3m/1m/1w/day ‚Äî widths proportional
      const segments = [
        {key:'6 months', width:180, tone:'seg-blue'},
        {key:'3 months', width:90, tone:'seg-blue'},
        {key:'1 month', width:30, tone:'seg-yellow'},
        {key:'1 week', width:7, tone:'seg-red'},
        {key:'day', width:1, tone:'seg-green'}
      ];
      const total = segments.reduce((a,b)=>a+b.width,0);

      segments.forEach(seg=>{
        const el = document.createElement('div');
        el.className = 'segment ' + seg.tone;
        el.style.flex = String(seg.width);
        el.innerHTML = `<div style="pointer-events:none">${seg.key}</div>`;
        timelineRow.appendChild(el);
      });

      // pins: place relative based on days before wedding (180 -> 0%)
      const totalSpan = 180;
      tasks.forEach(t=>{
        if(!t.due) return;
        const due = new Date(t.due + 'T00:00:00');
        const w = new Date(weddingDate + 'T00:00:00');
        let daysBefore = daysBetween(due, w);
        // clamp between 0..180
        daysBefore = Math.max(Math.min(daysBefore, totalSpan), 0);
        let pos = (totalSpan - daysBefore) / totalSpan; // 0..1 (earlier -> small pos)
        // position in px relative to timelineRow width
        const pin = document.createElement('div');
        pin.className = 'pin';
        const s = calcStatus(t);
        if(s === 'on') pin.style.background = 'linear-gradient(180deg,#5cc8ff,#6b5cff)';
        if(s === 'almost') pin.style.background = 'linear-gradient(180deg,#ffd57a,#ffb06b)';
        if(s === 'late') pin.style.background = 'linear-gradient(180deg,#ff8a8a,#ff4d4d)';
        if(s === 'completed') pin.style.background = 'linear-gradient(180deg,#7ef0b2,#3bd07a)';
        // compute left based on container width after layout
        timelineRow.appendChild(pin);
        // delay compute after appended and layout (use rAF)
        requestAnimationFrame(()=> {
          const rect = timelineRow.getBoundingClientRect();
          const x = rect.left + pos * rect.width;
          pin.style.left = (pos*100) + '%';
          pin.title = `${t.title} ‚Äî ${t.due} (${categoryLabel(t)})`;
          pin.dataset.id = t.id;
          pin.style.opacity = '0.98';
        });
      });
    }

    /* --------------------- Render tasks list --------------------- */
    function renderTasks(){
      taskList.innerHTML = '';
      // filter & sort
      let list = tasks.slice();
      if(filterMode !== 'all'){
        list = list.filter(t => {
          const s = calcStatus(t);
          return s === filterMode;
        });
      }
      list.sort((a,b) => {
        const da = new Date(a.due + 'T00:00:00');
        const db = new Date(b.due + 'T00:00:00');
        return sortMode === 'asc' ? da - db : db - da;
      });

      if(list.length === 0){
        emptyNote.style.display = 'block';
      } else {
        emptyNote.style.display = 'none';
      }

      list.forEach(t=>{
        const st = calcStatus(t);
        const card = document.createElement('div');
        card.className = 'taskCard';
        const completeClass = t.status === 'completed' ? 'completedTitle' : '';
        const dueLabel = t.due ? t.due : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô';
        card.innerHTML = `
          <div class="taskIcon" aria-hidden>
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M12 5v14M5 12h14" stroke="#111827" stroke-opacity="0.08" stroke-width="2" stroke-linecap="round"></path>
            </svg>
          </div>
          <div class="taskBody">
            <div class="taskTitle ${completeClass}">${escapeHtml(t.title)}</div>
            <div class="taskMeta">${escapeHtml(t.desc||'')} <div style="display:inline-block;margin-left:6px" class="label-pill">${dueLabel}</div></div>
            <div style="margin-top:8px" class="tiny muted">‡∏´‡∏°‡∏ß‡∏î: ${categoryLabel(t)}</div>
          </div>
          <div class="taskActions">
            <button class="btn-glass markBtn">${t.status === 'completed' ? 'Unmark' : 'Done'}</button>
            <button class="btn-glass" data-edit="${t.id}">Edit</button>
            <button class="btn-glass" data-del="${t.id}">Delete</button>
          </div>
        `;
        // events
        const markBtn = card.querySelector('.markBtn');
        markBtn.addEventListener('click', ()=>{
          t.status = (t.status === 'completed') ? 'pending' : 'completed';
          save(); renderAll();
        });
        card.querySelector('[data-edit]')?.addEventListener('click', ()=>{
          openEditModal(t.id);
        });
        card.querySelector('[data-del]')?.addEventListener('click', ()=>{
          if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
            tasks = tasks.filter(x=> x.id !== t.id);
            save(); renderAll();
          }
        });

        taskList.appendChild(card);
      });
    }

    /* --------------------- countdown --------------------- */
    function updateCountdown(){
      if(!weddingDate){
        countdown.textContent = '‚Äî';
        wdateText.textContent = '‚Äî';
        return;
      }
      const now = new Date();
      const wed = new Date(weddingDate + 'T00:00:00');
      const diff = wed - now;
      if(diff <= 0){
        countdown.textContent = '‡∏ß‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß üéâ';
        wdateText.textContent = weddingDate;
        return;
      }
      const d = Math.floor(diff / (1000*60*60*24));
      const h = Math.floor((diff / (1000*60*60)) % 24);
      const m = Math.floor((diff / (1000*60)) % 60);
      const s = Math.floor((diff / 1000) % 60);
      countdown.textContent = `${d}d ${pad(h)}h ${pad(m)}m ${pad(s)}s`;
      wdateText.textContent = weddingDate;
    }
    setInterval(updateCountdown, 1000);

    /* --------------------- UI helpers --------------------- */
    function escapeHtml(s){ if(!s) return ''; return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    /* --------------------- Modal handling --------------------- */
    fab.addEventListener('click', ()=>{
      fId.value = '';
      fTitle.value = '';
      fDesc.value = '';
      fDue.value = '';
      fStatus.value = 'pending';
      modalTitle.textContent = 'Add Task';
      taskModal.show();
    });

    function openEditModal(id){
      const t = tasks.find(x=>x.id===id);
      if(!t) return;
      fId.value = t.id;
      fTitle.value = t.title;
      fDesc.value = t.desc;
      fDue.value = t.due;
      fStatus.value = t.status || 'pending';
      modalTitle.textContent = 'Edit Task';
      taskModal.show();
    }

    taskForm.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      const id = fId.value;
      const title = fTitle.value.trim();
      const desc = fDesc.value.trim();
      const due = fDue.value;
      const status = fStatus.value;
      if(!title || !due){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'); return; }
      if(id){
        const t = tasks.find(x=>x.id===id);
        if(t){
          t.title = title; t.desc = desc; t.due = due; t.status = (status==='completed'? 'completed': 'pending');
        }
      } else {
        tasks.push({id: uid(), title, desc, due, status: (status==='completed'? 'completed': 'pending')});
      }
      save(); renderAll(); taskModal.hide();
    });

    /* --------------------- Filter & Sort quick actions --------------------- */
    filterChip.addEventListener('click', ()=>{
      // cycle modes
      const modes = ['all','on','almost','late','completed'];
      const labels = {'all':'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î','on':'On Time','almost':'Almost','late':'Too Late','completed':'Completed'};
      const i = modes.indexOf(filterMode);
      filterMode = modes[(i+1)%modes.length];
      filterChip.textContent = labels[filterMode] || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
      renderAll();
    });
    sortChip.addEventListener('click', ()=>{
      sortMode = sortMode === 'asc' ? 'desc' : 'asc';
      sortChip.textContent = sortMode === 'asc' ? 'Sort: Oldest' : 'Sort: Nearest';
      renderAll();
    });

    /* --------------------- Load / Reset sample and clear --------------------- */
    $('#loadSample').addEventListener('click', ()=>{
      if(!confirm('‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      // map SAMPLE_TASKS with current wedding date
      tasks = SAMPLE_TASKS.map(t => ({
        id: uid(), title: t.title, desc: t.desc, due: relativeToWedding(weddingDate, t.dueOffset), status:t.status
      }));
      save(); renderAll();
    });
    $('#resetAll').addEventListener('click', ()=>{
      if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å localStorage ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      tasks = [];
      weddingDate = defaultWedding;
      localStorage.removeItem(KEY_TASKS);
      localStorage.removeItem(KEY_WEDDING);
      save(); renderAll();
    });

    /* --------------------- wedding date input --------------------- */
    weddingDateInput.value = weddingDate;
    weddingDateInput.addEventListener('change', ()=>{
      weddingDate = weddingDateInput.value || defaultWedding;
      // when wedding date changes, shift tasks if they were sample? we keep dates as-is.
      save(); renderAll();
    });

    /* --------------------- render all --------------------- */
    function renderAll(){
      load();
      renderTimeline();
      renderTasks();
      updateCountdown();
      // reflect wedding date input text
      weddingDateInput.value = weddingDate;
    }

    /* --------------------- initial load --------------------- */
    load();
    renderAll();

    /* --------------------- small UX: clicking on pin opens edit --------------------- */
    timelineRow.addEventListener('click', (ev)=>{
      const pin = ev.target.closest('.pin');
      if(pin && pin.dataset.id){
        openEditModal(pin.dataset.id);
      }
    });

    /* --------------------- end --------------------- */
  </script>
</body>
</html>
