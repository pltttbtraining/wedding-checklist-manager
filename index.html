<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wedding Checklist Manager</title>

  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --accent: #6c5ce7;
      --muted: #f7f6ff;
      --card-bg: #ffffff;
      --timeline-height: 72px;
    }
    body{
      background: linear-gradient(180deg, #fffefe 0%, #fff6f8 100%);
      min-height:100vh;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    .app-header{
      padding: 1.25rem;
      border-radius: .75rem;
      background: linear-gradient(90deg, rgba(108,92,231,0.08), rgba(252, 244, 255, 0.6));
      box-shadow: 0 4px 12px rgba(16,24,40,0.06);
    }
    .countdown {
      font-weight: 600;
      font-size: 1.05rem;
    }
    .timeline {
      height: var(--timeline-height);
      border-radius: .6rem;
      background: linear-gradient(90deg, #ffffff 0%, #fbfbff 100%);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.03);
      padding: 12px;
      position: relative;
    }
    .timeline-segment {
      height: 100%;
      display: inline-block;
      vertical-align: top;
      border-right: 1px dashed rgba(0,0,0,0.03);
      padding: 6px;
      box-sizing: border-box;
      position: relative;
    }
    .segment-label{
      font-size: .85rem;
      font-weight: 600;
      color: #1f2937;
    }
    .task-pin{
      position: absolute;
      top: 40%;
      transform: translateY(-50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.9);
      box-shadow: 0 2px 6px rgba(16,24,40,0.12);
    }
    .task-card .completed {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .badge-status {
      font-weight:600;
      padding: .45em .6em;
      font-size: .78rem;
      border-radius: .55rem;
    }
    /* Status color mapping (soft tones) */
    .status-on {
      background: rgba(59,130,246,0.12);
      color: #0369a1;
      border: 1px solid rgba(59,130,246,0.12);
    }
    .status-almost {
      background: rgba(234,179,8,0.12);
      color: #92400e;
      border: 1px solid rgba(234,179,8,0.12);
    }
    .status-late {
      background: rgba(239,68,68,0.12);
      color: #9b1c1c;
      border: 1px solid rgba(239,68,68,0.12);
    }
    .status-complete {
      background: rgba(34,197,94,0.12);
      color: #166534;
      border: 1px solid rgba(34,197,94,0.12);
    }
    /* small screens timeline vertical stacking */
    @media (max-width: 768px) {
      .timeline {
        height: auto;
        padding: 8px;
      }
      .timeline-segment {
        display: block;
        border-right: none;
        border-bottom: 1px dashed rgba(0,0,0,0.03);
        margin-bottom: 6px;
      }
      .task-pin{ top: auto; right: 12px; transform:none; }
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Header -->
    <div class="app-header mb-4">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div>
          <h2 class="mb-0">Wedding Checklist Manager</h2>
          <small class="text-muted">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô ‚Äî ‡∏°‡∏µ timeline, filter, sort ‡πÅ‡∏•‡∏∞ countdown</small>
        </div>

        <div class="d-flex gap-3 align-items-center">
          <div class="text-end">
            <div class="small text-muted">Wedding Date</div>
            <input id="weddingDateInput" type="date" class="form-control form-control-sm" />
          </div>
          <div class="text-end ps-2">
            <div class="small text-muted">Countdown</div>
            <div class="countdown" id="countdown">‚Äî</div>
          </div>
          <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal" id="addTaskBtn">
              + New Task
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline -->
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <strong>Timeline</strong>
          <div class="small text-muted">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (6m ‚Üí day)</div>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <select id="filterSelect" class="form-select form-select-sm">
            <option value="all">All statuses</option>
            <option value="on">On Time</option>
            <option value="almost">Almost Due</option>
            <option value="late">Too Late</option>
            <option value="completed">Completed</option>
          </select>
          <select id="sortSelect" class="form-select form-select-sm">
            <option value="asc">Sort: Oldest due</option>
            <option value="desc">Sort: Nearest due</option>
          </select>
        </div>
      </div>

      <div class="timeline" id="timelineBar" aria-hidden="false">
        <!-- segments inserted by JS -->
      </div>
    </div>

    <!-- Task list -->
    <div id="tasksContainer" class="row gy-3">
      <!-- cards inserted by JS -->
    </div>

    <!-- Empty state -->
    <div id="emptyState" class="text-center text-muted small mt-4 d-none">
      ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å "New Task" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
      <div class="mt-2">
        <button class="btn btn-outline-secondary btn-sm" id="loadSampleBtn">‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
        <button class="btn btn-outline-danger btn-sm" id="clearAllBtn">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
    </div>

    <div class="text-center mt-4 mb-5 small text-muted">Built with ‚ù§Ô∏è ‚Äî responsive & localStorage</div>
  </div>

  <!-- Task Modal (Add/Edit) -->
  <div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form class="modal-content" id="taskForm">
        <div class="modal-header">
          <h5 class="modal-title" id="taskModalTitle">New Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="taskId" />
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠ (Task Title)</label>
              <input id="taskTitle" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à (Due Date)</label>
              <input id="taskDue" type="date" class="form-control" required />
            </div>
            <div class="col-12">
              <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
              <textarea id="taskDesc" rows="3" class="form-control" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
            </div>
            <div class="col-12 d-flex gap-3 align-items-center">
              <div>
                <label class="form-label mb-0">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <select id="taskStatusSelect" class="form-select form-select-sm">
                  <option value="pending">Pending</option>
                  <option value="completed">Completed</option>
                </select>
              </div>
              <div class="ms-auto text-end">
                <div class="small text-muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
                <div class="text-muted small">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ OnTime/Almost/Late ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap & scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /***********************
     * Wedding Checklist Manager
     * - single-file app using localStorage
     * - features: add/edit/delete, mark complete, filter, sort
     * - timeline visualization and countdown
     ***********************/

    // ---------- Constants & storage keys ----------
    const STORAGE_KEY = 'weddingTasks_v1';
    const STORAGE_WEDDING_DATE = 'weddingDate_v1';

    // ---------- Utility helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function uid() {
      return 't_' + Math.random().toString(36).slice(2,9);
    }
    function toDateISO(d) {
      // ensure yyyy-mm-dd
      return new Date(d).toISOString().slice(0,10);
    }
    function daysBetween(a, b) {
      // days from a to b (b - a)
      const MS = 1000*60*60*24;
      const diff = Math.floor((Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()) - Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()))/MS);
      return diff;
    }

    // ---------- Initial sample data (user asked to expand) ----------
    const SAMPLE_WEDDING_DATE = (() => {
      const d = new Date();
      d.setMonth(d.getMonth() + 6); // default 6 months from now
      return toDateISO(d);
    })();

    const SAMPLE_TASKS = [
      // 6 months before
      { id: uid(), title: "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì", desc: "‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏ß‡∏î (‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà, ‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß, ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û)", due: relativeDate(-180), status: "pending" },
      { id: uid(), title: "‡∏à‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", desc: "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥", due: relativeDate(-170), status: "pending" },
      { id: uid(), title: "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ò‡∏µ‡∏°‡∏á‡∏≤‡∏ô", desc: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏ò‡∏µ‡∏°‡∏´‡∏•‡∏±‡∏Å", due: relativeDate(-165), status: "pending" },

      // 3 months before
      { id: uid(), title: "‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏•‡∏∂‡∏Å", desc: "‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á", due: relativeDate(-95), status: "pending" },
      { id: uid(), title: "‡∏à‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û", desc: "‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à", due: relativeDate(-92), status: "pending" },
      { id: uid(), title: "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏°‡∏ô‡∏π", desc: "‡∏ä‡∏¥‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£", due: relativeDate(-85), status: "pending" },

      // 1 month before
      { id: uid(), title: "‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏ä‡∏¥‡∏ç", desc: "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏ä‡∏¥‡∏ç", due: relativeDate(-30), status: "pending" },
      { id: uid(), title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£", desc: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡∏µ‡∏•‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û, ‡πÅ‡∏Ñ‡πÄ‡∏ó‡∏≠‡∏£‡∏¥‡πà‡∏á)", due: relativeDate(-28), status: "pending" },

      // 1 week before
      { id: uid(), title: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®", desc: "‡πÄ‡∏ä‡πá‡∏Å‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á", due: relativeDate(-6), status: "pending" },
      { id: uid(), title: "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ", desc: "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô, ‡∏ä‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏≠‡∏á, ‡∏¢‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥", due: relativeDate(-5), status: "pending" },

      // Day of
      { id: uid(), title: "‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", desc: "‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Å‡πÅ‡∏™‡∏á‡∏™‡∏µ", due: relativeDate(0), status: "pending" },
      { id: uid(), title: "‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏Ç‡∏Å", desc: "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ó‡∏µ‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ã‡∏±‡∏Å‡∏ã‡πâ‡∏≠‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà", due: relativeDate(0), status: "pending" },

      // Additional helpful items
      { id: uid(), title: "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏û‡∏¥‡∏ò‡∏µ", desc: "‡∏ß‡∏≤‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏¥‡∏ò‡∏µ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏û‡∏π‡∏î", due: relativeDate(-15), status: "pending" },
      { id: uid(), title: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏á", desc: "‡∏£‡∏ß‡∏°‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏ò‡∏µ‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á", due: relativeDate(-40), status: "pending" },
      { id: uid(), title: "‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á", desc: "‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÅ‡∏Ç‡∏Å VIP", due: relativeDate(-25), status: "pending" },
    ];

    // relativeDate(n) returns a date string relative to SAMPLE_WEDDING_DATE.
    // n is days before wedding (negative for before).
    function relativeDate(daysBefore) {
      const wedding = new Date(SAMPLE_WEDDING_DATE);
      const due = new Date(wedding.getFullYear(), wedding.getMonth(), wedding.getDate());
      due.setDate(due.getDate() + daysBefore);
      return toDateISO(due);
    }

    // ---------- App state ----------
    let tasks = [];
    let weddingDate = localStorage.getItem(STORAGE_WEDDING_DATE) || SAMPLE_WEDDING_DATE;

    // ---------- DOM elements ----------
    const timelineBar = $('#timelineBar');
    const tasksContainer = $('#tasksContainer');
    const taskModalEl = document.getElementById('taskModal');
    const taskModal = new bootstrap.Modal(taskModalEl);
    const taskForm = $('#taskForm');
    const taskModalTitle = $('#taskModalTitle');

    const weddingDateInput = $('#weddingDateInput');
    const countdownEl = $('#countdown');
    const filterSelect = $('#filterSelect');
    const sortSelect = $('#sortSelect');

    const loadSampleBtn = $('#loadSampleBtn');
    const clearAllBtn = $('#clearAllBtn');
    const addTaskBtn = $('#addTaskBtn');

    // ---------- Initialization ----------
    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          tasks = JSON.parse(raw);
        } catch(e) {
          tasks = [];
        }
      } else {
        tasks = [];
      }
      const w = localStorage.getItem(STORAGE_WEDDING_DATE);
      if (w) weddingDate = w;
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      localStorage.setItem(STORAGE_WEDDING_DATE, weddingDate);
    }

    function seedSampleData() {
      tasks = SAMPLE_TASKS.map(t => ({...t})); // copy
      weddingDate = SAMPLE_WEDDING_DATE;
      saveToStorage();
      renderAll();
    }

    // ---------- Status Calculation ----------
    // status codes: 'on' (On Time), 'almost' (Almost Due), 'late' (Too Late)
    // completed tasks get 'completed'
    function calcStatusForTask(task) {
      if (!task || !task.due) return 'on';
      if (task.status === 'completed') return 'completed';

      const today = new Date();
      const due = new Date(task.due + 'T00:00:00');
      const daysLeft = daysBetween(today, due);

      // Define threshold for "Almost Due": within 3 days (including today)
      // If due is in the past (daysLeft < 0) => Too Late
      if (daysLeft < 0) return 'late';
      if (daysLeft <= 3) return 'almost';
      return 'on';
    }

    // ---------- Category (time-before-event) ----------
    // Categorize by days before wedding
    function categoryForTask(task) {
      if (!weddingDate) return 'Unscheduled';
      const wed = new Date(weddingDate + 'T00:00:00');
      const due = new Date(task.due + 'T00:00:00');
      const daysBefore = daysBetween(due, wed); // positive if due is before wedding

      if (daysBefore >= 180) return '6 months before';
      if (daysBefore >= 90) return '3 months before';
      if (daysBefore >= 30) return '1 month before';
      if (daysBefore >= 7) return '1 week before';
      if (daysBefore >= 0) return 'day of event';
      return 'After event';
    }

    // ---------- Render timeline ----------
    function renderTimeline() {
      timelineBar.innerHTML = '';
      // segments: 6m / 3m / 1m / 1w / day
      const segs = [
        {key:'6 months before', label: '6 months'},
        {key:'3 months before', label: '3 months'},
        {key:'1 month before', label: '1 month'},
        {key:'1 week before', label: '1 week'},
        {key:'day of event', label: 'Day'},
      ];

      // compute width of each segment proportional to days window:
      // 6m: 180 days, 3m: 90, 1m:30, 1w:7, day:1
      const widths = [180,90,30,7,1];
      const total = widths.reduce((a,b)=>a+b,0);
      segs.forEach((s, idx) => {
        const w = (widths[idx] / total) * 100;
        const seg = document.createElement('div');
        seg.className = 'timeline-segment';
        seg.style.width = w + '%';
        seg.innerHTML = `<div class="segment-label">${s.label}</div>`;
        seg.dataset.key = s.key;
        timelineBar.appendChild(seg);
      });

      // place pins for tasks proportionally inside the whole timeline: from 6 months-before point to day
      // We'll map relative position based on daysBefore (180 ‚Üí 0% ... 0 ‚Üí 100%)
      const allTasks = visibleTasksForTimeline();
      const totalDaysSpan = 180; // from 180 days before to event
      allTasks.forEach(t => {
        if (!t.due) return;
        const due = new Date(t.due + 'T00:00:00');
        const wed = new Date(weddingDate + 'T00:00:00');
        const daysBefore = Math.round(daysBetween(due, wed));
        // clamp
        let pos = (180 - daysBefore) / totalDaysSpan; // 0..1
        pos = Math.max(0, Math.min(1, pos));

        const pin = document.createElement('div');
        pin.className = 'task-pin';
        const st = calcStatusForTask(t);
        if (st === 'on') pin.style.background = 'rgba(59,130,246,0.9)';       // blue
        if (st === 'almost') pin.style.background = 'rgba(234,179,8,0.9)';    // yellow
        if (st === 'late') pin.style.background = 'rgba(239,68,68,0.9)';      // red
        if (st === 'completed') pin.style.background = 'rgba(34,197,94,0.9)'; // green
        pin.title = `${t.title} ‚Äî due ${t.due} (${categoryForTask(t)})`;

        // position relative to timelineBar
        const leftPercent = (pos * 100).toFixed(2) + '%';
        pin.style.left = leftPercent;
        pin.style.zIndex = 5;
        timelineBar.appendChild(pin);
      });
    }

    function visibleTasksForTimeline() {
      // show all tasks that are within 180 days before wedding, else clamp
      return tasks.slice();
    }

    // ---------- Render task list ----------
    function renderTasks() {
      tasksContainer.innerHTML = '';

      const filter = filterSelect.value;
      const sort = sortSelect.value;

      let list = tasks.slice();

      // filter
      if (filter !== 'all') {
        list = list.filter(t => {
          const st = calcStatusForTask(t);
          return filter === 'completed' ? st === 'completed' : st === filter;
        });
      }

      // sort
      list.sort((a,b) => {
        const da = new Date(a.due + 'T00:00:00');
        const db = new Date(b.due + 'T00:00:00');
        return sort === 'asc' ? da - db : db - da;
      });

      if (list.length === 0) {
        $('#emptyState').classList.remove('d-none');
      } else {
        $('#emptyState').classList.add('d-none');
      }

      list.forEach(t => {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-6 col-lg-4';

        const st = calcStatusForTask(t);
        const statusBadge = (() => {
          if (st === 'on') return `<span class="badge-status status-on">On Time</span>`;
          if (st === 'almost') return `<span class="badge-status status-almost">Almost Due</span>`;
          if (st === 'late') return `<span class="badge-status status-late">Too Late</span>`;
          if (st === 'completed') return `<span class="badge-status status-complete">Completed</span>`;
          return `<span class="badge-status status-on">On Time</span>`;
        })();

        const card = document.createElement('div');
        card.className = 'card task-card shadow-sm h-100';
        card.innerHTML = `
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="card-title mb-1 ${t.status === 'completed' ? 'completed' : ''}">${escapeHtml(t.title)}</h5>
                <div class="small text-muted">${escapeHtml(t.desc || '')}</div>
              </div>
              <div class="text-end">
                <div>${statusBadge}</div>
                <div class="small text-muted mt-2">${t.due}</div>
              </div>
            </div>

            <div class="mt-3 d-flex gap-2 align-items-center mt-auto">
              <button class="btn btn-sm btn-outline-success markCompleteBtn">${t.status === 'completed' ? 'Unmark' : 'Mark Complete'}</button>
              <button class="btn btn-sm btn-outline-primary editBtn">Edit</button>
              <button class="btn btn-sm btn-outline-danger deleteBtn ms-auto">Delete</button>
            </div>
          </div>
        `;

        // events
        card.querySelector('.editBtn').addEventListener('click', () => openEditModal(t.id));
        card.querySelector('.deleteBtn').addEventListener('click', () => {
          if (confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            tasks = tasks.filter(x => x.id !== t.id);
            saveToStorage();
            renderAll();
          }
        });
        card.querySelector('.markCompleteBtn').addEventListener('click', (e) => {
          t.status = t.status === 'completed' ? 'pending' : 'completed';
          saveToStorage();
          renderAll();
        });

        col.appendChild(card);
        tasksContainer.appendChild(col);
      });
    }

    // ---------- Helpers ----------
    function escapeHtml(str){ if(!str) return ''; return (''+str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // ---------- Form handling ----------
    addTaskBtn.addEventListener('click', () => {
      $('#taskId').value = '';
      $('#taskTitle').value = '';
      $('#taskDesc').value = '';
      $('#taskDue').value = '';
      $('#taskStatusSelect').value = 'pending';
      taskModalTitle.textContent = 'New Task';
      taskModal.show();
    });

    function openEditModal(id) {
      const t = tasks.find(x => x.id === id);
      if (!t) return;
      $('#taskId').value = t.id;
      $('#taskTitle').value = t.title;
      $('#taskDesc').value = t.desc;
      $('#taskDue').value = t.due;
      $('#taskStatusSelect').value = t.status || 'pending';
      taskModalTitle.textContent = 'Edit Task';
      taskModal.show();
    }

    taskForm.addEventListener('submit', (ev) => {
      ev.preventDefault();
      const id = $('#taskId').value;
      const title = $('#taskTitle').value.trim();
      const desc = $('#taskDesc').value.trim();
      const due = $('#taskDue').value;
      const statusSel = $('#taskStatusSelect').value;

      if (!title || !due) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
        return;
      }

      if (id) {
        // edit
        const t = tasks.find(x => x.id === id);
        if (t) {
          t.title = title;
          t.desc = desc;
          t.due = due;
          t.status = statusSel === 'completed' ? 'completed' : (t.status === 'completed' ? 'completed' : 'pending');
        }
      } else {
        // new
        const newTask = { id: uid(), title, desc, due, status: statusSel === 'completed' ? 'completed' : 'pending' };
        tasks.push(newTask);
      }

      saveToStorage();
      renderAll();
      taskModal.hide();
    });

    // ---------- Wedding date & countdown ----------
    function renderWeddingDateInput(){
      weddingDateInput.value = weddingDate;
      weddingDateInput.addEventListener('change', () => {
        weddingDate = weddingDateInput.value;
        saveToStorage();
        renderAll();
      });
    }

    function updateCountdown() {
      if (!weddingDate) {
        countdownEl.textContent = '‚Äî';
        return;
      }
      const now = new Date();
      const wed = new Date(weddingDate + 'T00:00:00');
      const diff = wed - now;
      if (diff <= 0) {
        countdownEl.textContent = '‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß üéâ';
        return;
      }
      const d = Math.floor(diff / (1000*60*60*24));
      const h = Math.floor((diff / (1000*60*60)) % 24);
      const m = Math.floor((diff / (1000*60)) % 60);
      const s = Math.floor((diff / 1000) % 60);
      countdownEl.textContent = `${d}d ${pad(h)}h ${pad(m)}m ${pad(s)}s`;
    }
    function pad(n){ return n.toString().padStart(2,'0'); }

    // update countdown every 1s
    setInterval(updateCountdown, 1000);

    // ---------- Filters / Sorting ----------
    filterSelect.addEventListener('change', () => renderAll());
    sortSelect.addEventListener('change', () => renderAll());

    // ---------- Buttons ----------
    loadSampleBtn.addEventListener('click', () => {
      if (!confirm('‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      seedSampleData();
    });
    clearAllBtn.addEventListener('click', () => {
      if (!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å localStorage ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      tasks = [];
      weddingDate = SAMPLE_WEDDING_DATE;
      saveToStorage();
      renderAll();
    });

    // ---------- Rendering helper ----------
    function renderAll() {
      loadFromStorage();
      renderWeddingDateInput();
      renderTimeline();
      renderTasks();
      updateCountdown();
      saveToStorage();
    }

    // ---------- On first load, if no data, seed samples ----------
    loadFromStorage();
    if (!localStorage.getItem(STORAGE_KEY) || tasks.length === 0) {
      // seed sample tasks (but do not overwrite if user had set weddingDate)
      tasks = SAMPLE_TASKS.map(t => ({...t}));
      saveToStorage();
    }
    renderAll();

    // ---------- small helper: keep stored weddingDate if none set by user ----------
    if (!localStorage.getItem(STORAGE_WEDDING_DATE)) {
      localStorage.setItem(STORAGE_WEDDING_DATE, weddingDate);
    }

    // ---------- Explanation (in console) ----------
    console.log("Wedding Checklist Manager initialized.");
    console.log("Storage key:", STORAGE_KEY, "Wedding date key:", STORAGE_WEDDING_DATE);

  </script>
</body>
</html>
